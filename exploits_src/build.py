import os
import shutil
import subprocess

SCRIPT_DIR = os.path.dirname(__file__)
RAVAGE_BUILD_DIR = os.path.abspath(f'{SCRIPT_DIR}/../ravage/resources/build')


def build():
    if os.path.isdir(RAVAGE_BUILD_DIR):
        shutil.rmtree(RAVAGE_BUILD_DIR)
    os.mkdir(RAVAGE_BUILD_DIR)

    # Chameleon
    os.mkdir(f'{RAVAGE_BUILD_DIR}/chameleon')
    __run_command(f'gcc -Wall -fPIC -shared -o {RAVAGE_BUILD_DIR}/chameleon/libprocesshider.so {SCRIPT_DIR}/chameleon/processhider.c -ldl')
    __run_command(f'gcc -Wall -fPIC -shared -o {RAVAGE_BUILD_DIR}/chameleon/libnetworkhider.so {SCRIPT_DIR}/chameleon/networkhider.c -ldl')


def __run_command(command: str):
    p = subprocess.Popen(
        command,
        shell=True,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL
    )
    if p.wait() != 0:
        raise Exception(f'Command Failed with non-zero code: {command}')
